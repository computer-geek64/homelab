- name: Gitea database
  hosts: localhost
  tasks:
  - name: Create gitea postgres user
    community.postgresql.postgresql_user:
      login_host: localhost
      login_user: postgres
      login_password: '{{config.postgres_password}}'
      login_db: postgres
      name: gitea
      password: '{{config.gitea_postgres_password}}'
      state: present
  - name: Create gitea postgres db
    community.postgresql.postgresql_db:
      login_host: localhost
      login_user: postgres
      login_password: '{{config.postgres_password}}'
      maintenance_db: postgres
      name: gitea
      owner: gitea
      state: present

- name: Gitea docker
  hosts: localhost
  tasks:
  - name: Create gitea docker volume
    vars:
      volume_name: homelab-gitea-data
    ansible.builtin.import_tasks: ../util/create_docker_volume.yaml
  - name: Start gitea docker container
    community.docker.docker_container:
      name: homelab-gitea-bootstrap
      image: gitea/gitea:latest
      pull: true
      networks:
      - name: homelab-postgres-bootstrap
      published_ports:
      - 8002:8002
      env:
        GITEA__database__DB_TYPE: postgres
        GITEA__database__HOST: postgres
        GITEA__database__NAME: gitea
        GITEA__database__USER: gitea
        GITEA__database__PASSWD: '{{config.gitea_postgres_password}}'
        GITEA__server__HTTP_PORT: '8002'
        GITEA__server__ROOT_URL: https://gitea.homelab.net
        GITEA__server__OFFLINE_MODE: 'true'
        GITEA__server__DISABLE_SSH: 'true'
        APP_NAME: Gitea
      volumes:
      - homelab-gitea-data:/data
      - /etc/localtime:/etc/localtime:ro
      auto_remove: true
      keep_volumes: false
      state: started
  - name: Wait for gitea to come online
    ansible.builtin.wait_for:
      port: 8002
      state: started
  - name: Wait for confirmation
    ansible.builtin.pause:
      prompt: Go to https://gitea.homelab.net and finish Gitea setup

- name: Gitea install cleanup
  hosts: localhost
  tasks:
  - name: Stop gitea container
    community.docker.docker_container:
      name: homelab-gitea-bootstrap
      state: absent
