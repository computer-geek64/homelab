- name: Planka database
  hosts: localhost
  tasks:
  - name: Create planka postgres user
    community.postgresql.postgresql_user:
      login_host: localhost
      login_user: postgres
      login_password: '{{config.postgres_password}}'
      login_db: postgres
      name: planka
      password: '{{config.planka_postgres_password}}'
      state: present
  - name: Create planka postgres db
    community.postgresql.postgresql_db:
      login_host: localhost
      login_user: postgres
      login_password: '{{config.postgres_password}}'
      maintenance_db: postgres
      name: planka
      owner: planka
      state: present

- name: Planka docker
  hosts: localhost
  tasks:
  - name: Create planka docker volume
    vars:
      volume_name: homelab-planka-data
    ansible.builtin.import_tasks: ../util/create_docker_volume.yaml
  - name: Start planka docker container
    community.docker.docker_container:
      name: homelab-planka-bootstrap
      image: ghcr.io/plankanban/planka:latest
      pull: true
      networks:
      - name: homelab-postgres-bootstrap
      published_ports:
      - 8006:1337
      env:
        BASE_URL: http://localhost:8006
        #TRUST_PROXY: 1
        DATABASE_URL: 'postgresql://planka:{{config.planka_postgres_password}}@postgres/planka'
        NODE_ENV: production
        SECRET_KEY: '{{config.planka_secret_key}}'
      volumes:
      - homelab-planka-data:/app
      - /etc/localtime:/etc/localtime:ro
      auto_remove: true
      keep_volumes: false
      state: started
  - name: Wait for planka to come online
    ansible.builtin.wait_for:
      port: 8006
      state: started
  - name: Wait for confirmation
    ansible.builtin.pause:
      prompt: Go to http://localhost:8006/ and finish Planka setup

- name: Planka install cleanup
  hosts: localhost
  tasks:
  - name: Stop planka container
    community.docker.docker_container:
      name: homelab-planka-bootstrap
      state: absent
